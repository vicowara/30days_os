# 6日目

### harib03a
ファイル分割。

### harib03b
Makefileの一般規則の導入。

### harib03c
ヘッダファイルの導入。

### harib03d
昨日の内容の説明。  
GDTRは48bitで、下位16bitにlimit、残りの32bitにGDTのアドレスが格納される。
limitとは大きさを表し、GDT(セグメント？)の有効バイト数-1。
IDTRもGDTRと同様に設定を行う。  
set_segmdescの処理を追う。まず最初のif文はlimitが0xffff以上であった時にG(Granularity)フラグを立てる処理。Gフラグが立っているときはlimitをバイト単位からページ単位(1ページ=4KB)で読み込むようになる。そのためバイト単位で渡されているlimitを4096(=0x1000)で割っている。
次にbase(起点となるアドレス)は互換性のためにbase\_low(2byte)とbase\_mid(1byte)、base\_high(1byte)に分けて記述する必要がある。limitはlimit\_low(2byte)とlimit\_high(1byte)しかない上に、limit\_highのうち上位4bitはセグメント情報を記述するため20bitしか使えない。しかしGフラグが立っているときはページ単位で読み込まれるため4096*2^20bitで4GBまで読み込み可能になる。  
セグメント属性はGD00 0000 xxxx xxxxの16bitとなり、Dが1のときは32bitモード、0のときは16bitモードになる。下位8bit(x)はシステムモード(リング0)やアプリケーションモード(リング3)の設定であったり実行権限や書き込み権限を設定する。本の126ページを参照すること。

### harib03e
PICの初期化。PICなどの説明は下のリストに大体まとめた。ICWとIMRを初期化している。

### harib03f
割り込みハンドラの作成。マウスのIRQが12、キーボードのIRQが1なので、それに対応するINT 0x2c,0x21の設定を行う。割り込み処理が終わった時にはIRETD命令を実行する必要があるがC言語では出来ないためアセンブリを用いる。アセンブリからC言語の関数をcallしているが、C言語ではDSもESもSSも同じセグメントを指している必要があるためその準備も行っている。PUSHADではE(A|C|D|B)XとE(S|B)PとE(S|D)Iの8つのレジスタをpushする。POPADも同じレジスタをpopする。  
作成したハンドラをIDTに登録する。0x21,0x2c以外にも0x27も設定しているが、これはノイズからなる誤検知？なのでその対応用。無視できない？
IDTに登録する際セグメント番号も必要になるので、0x280000から0x07ffバイトを使用するセグメント番号2、つまりbootpack.hrbが展開されるセグメントを指定する。

---------
* LGDT…Load Global (segment) Descriptor Table命令。ロードだがレジスタ(GDTR)から読み込む命令ではなく、レジスタ(GDTR)に読み込ませる命令。
* LIDT…Load Interrupt Descriptor Table命令。
* PIC…Programable Interrupt Controller。設定可能な割り込みコントローラ。CPUは単独では1つしか割り込みを扱えない設計になっているが、それを補うための補助チップのこと。PICは8つの割り込み信号を一つの割り込みにまとめることができる。このPIC(マスタ)にもうひとつPIC(スレーブ)を繋げることで、計15個の割り込み信号が扱えるようになる。
* IRQ…Interrupt REquest。割り込み要求。
* ICW…Initial Control Word。初期化制御データ。PIC上の設定用レジスタ。ICW1〜4まであり、すべて8bit。1と4については詳しく説明されていない。ICW3はマスタスレーブ用の設定で、マスタ側のICW3は8bitで、スレーブが接続されているビットを1に設定する。今回はIRQの2番なので00000100。一方スレーブ側のICW3では繋がっているIRQの番号を3bitで指定する。今回は2番なので2進数で表して010。ICW2はIRQをどの割り込み番号としてCPUに通知するかを設定するためのレジスタ。INTの最小値(0x20-27で受けるときは0x20)を指定する？
* IMR…Interrupt Mask Register。ICWと同じくPIC上の設定用レジスタ。8bitあり、各ビットがIRQ信号に対応しており、1が立っていればそのIRQ信号は無視される。
