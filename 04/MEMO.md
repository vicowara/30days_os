# 4日目

4日目は難しい。あと、ようやく公式サイトにあるLinux向けバイナリに気がついたので、以降は参考サイトではなくそちらを使う。

```
wget http://hrb.osask.jp/z_tools.tar.bz2
tar jxvf z_tools.tar.bz2
```

拡張子がexeだが実際はELFフォーマットなので気にせずに使う。
中に入っているMakefile.patchを各ディレクトリのMakefileに適用すればよい。
ただしqemuのオプションが-std-vgaという古い(?)ものを使っていたり、そもそもqemuなんてコマンドが無かったり(qemu-system-x86_64がコマンド名)するので若干パッチも弄った。
面倒なので./prepare.sh [%02d]といった風に日付を入力するとprojectsからプログラムをコピーしてきてパッチしてくれるスクリプトを書いたので以降はこれを使う。

### harib01a
C言語からメモリの指定番地に適当なデータを書き込む。
まずはポインタを使わずに、メモリ書き込み用の関数をアセンブラで作るところから始まる。怖い。
32bitモードでは16bitモードではオペランドに指定できなかったレジスタも指定できる。
作成したwrite_mem8を使ってVRAM全体に15という色を書き込んでいるので、実行すると画面が真っ白になる。

### harib01b
write_mem8を使って縞模様を描画する。論理演算の話が主。

### harib01c
ポインタを使って縞模様を描画する。ほとんどポインタの話。

### harib01d,e
配列の導入。シュガーシンタックスとかそのへん。

### harib01f
デフォルトの色(パレット)ではなく独自定義のパレットを使用して縞模様を描画する。やたらと新要素が満載なので難しい。  
ビデオDAコンバータ(?)にOUT命令で書き込みを行う際には割り込みが発生すると困るので、現在のフラグを丸々eflagsに保存してから割り込みを禁止し、書き込みを行った後にフラグを元に戻す作業を行う。周辺機器へのアクセスはすべて割り込みは禁止したほうがよい？それともビデオDAコンバータにアクセスするときのみ？  
rgb[0]/4は右シフト？io_out8の8が8bitの意であることは間違いないが、謎。

### harib01g
四角を描画する。vram[x+y*320]にカラーコードを書くことで指定座標に色を描画できる。

### harib01h
四角を描画することでタスクバー風の画面を作成する。

------

*INSTRSET…CPUの命令セットを指定する？指定しない場合は8086(16bit向けの命令セット)になる。今回は486を指定する。
*CLI(CLear Interrupt flag)…割り込みフラグを0にする。割り込みが無視される？
*STI(SeT Interrupt flag)…割り込みフラグを1にする。割り込みに対応する？
